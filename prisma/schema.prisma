generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PositionName {
  LEAD_LIBRARIAN @map("Провідний бібліотекар")
  LIBRARIAN_1    @map("Бібліотекар І категорії")
  LIBRARIAN_2    @map("Бібліотекар ІІ категорії")
  LIBRARIAN      @map("Бібліотекар")
}

enum DepartmentName {
  E_LIBRARY     @map("Відділ електронної бібліотеки")
  READING_HALLS @map("Відділ читальних залів")
  RARE_BOOKS    @map("Відділ рідкісних і цінних книг")
}

enum LoanStatus {
  ISSUED   @map("Видано")
  RETURNED @map("Повернено")
  OVERDUE  @map("Прострочено")
}

enum FineStatus {
  ISSUED  @map("Нараховано")
  PAID    @map("Сплачено")
  WAIVED  @map("Списано")
}

model Category {
  id    Int            @id @default(autoincrement()) @map("category_id")
  name  String         @map("category_name") @db.VarChar(32)
  books BookCategory[]

  @@map("Category")
}

model Publisher {
  id      Int    @id @default(autoincrement()) @map("pub_id")
  name    String @db.VarChar(32)
  address String @db.Text
  books   Book[]

  @@map("Publisher")
}

model Author {
  id        Int          @id @default(autoincrement()) @map("author_id")
  name      String       @db.VarChar(32)
  surname   String       @db.VarChar(32)
  birthYear Int?         @map("birth_year") @db.SmallInt
  country   String?      @db.VarChar(32)
  books     AuthorBook[]

  @@index([surname])
  @@map("Author")
}

model Book {
  id              Int            @id @default(autoincrement()) @map("book_id")
  title           String         @db.VarChar(64)
  publicationYear Int?           @map("publication_year") @db.SmallInt
  publisherId     Int            @map("pub_id")
  publisher       Publisher      @relation(fields: [publisherId], references: [id])
  
  authors         AuthorBook[]
  categories      BookCategory[]
  loans           Loan[]

  createdAt       DateTime       @default(now()) @map("created_at")

  @@index([title])
  @@map("Book")
}

model AuthorBook {
  authorId Int    @map("author_id")
  bookId   Int    @map("book_id")
  author   Author @relation(fields: [authorId], references: [id], onDelete: Cascade)
  book     Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@id([authorId, bookId])
  @@map("AuthorBook")
}

model BookCategory {
  categoryId Int      @map("category_id")
  bookId     Int      @map("book_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  book       Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@id([categoryId, bookId])
  @@map("BookCategory")
}

model Librarian {
  id         Int             @id @default(autoincrement()) @map("librarian_id")
  name       String          @db.VarChar(32)
  surname    String          @db.VarChar(32)
  position   PositionName?
  department DepartmentName?
  email      String          @unique @db.VarChar(32)
  loans      Loan[]

  @@map("Librarian")
}

model Member {
  id               Int       @id @default(autoincrement()) @map("member_id")
  name             String    @db.VarChar(32)
  surname          String    @db.VarChar(32)
  address          String    @db.Text
  phoneNumber      String?   @unique @map("phone_number") @db.VarChar(13)
  registrationDate DateTime  @default(now()) @map("registration_date") @db.Date

  deletedAt        DateTime? @map("deleted_at")
  
  loans            Loan[]

  @@index([phoneNumber])
  @@map("Member")
}

model Loan {
  id          Int        @id @default(autoincrement()) @map("loan_id")
  memberId    Int        @map("member_id")
  bookId      Int        @map("book_id")
  librarianId Int        @map("librarian_id")
  loanDate    DateTime   @default(now()) @map("loan_date") @db.Date
  returnDate  DateTime?  @map("return_date") @db.Date
  status      LoanStatus @default(ISSUED)
  
  member      Member     @relation(fields: [memberId], references: [id])
  book        Book       @relation(fields: [bookId], references: [id])
  librarian   Librarian  @relation(fields: [librarianId], references: [id])
  fine        Fine?

  @@index([status])
  @@map("Loan")
}

model Fine {
  id     Int        @id @default(autoincrement()) @map("fine_id")
  loanId Int        @unique @map("loan_id")
  amount Decimal    @db.Decimal(6, 2)
  status FineStatus @default(ISSUED)
  
  loan   Loan       @relation(fields: [loanId], references: [id])

  @@map("Fine")
}